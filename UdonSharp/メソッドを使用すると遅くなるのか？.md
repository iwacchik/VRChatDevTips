# メソッドを使用すると遅くなるのか？【UdonSharp パフォーマンス調査】
[クラス構造のアクセス速度をベンチマーク](https://gist.github.com/iwacchik/0eb3ed98d89892a6b8a5435f89e1b77f)した際、直接DataListを操作した場合と[闇クラス](https://power-of-tech.hatenablog.com/entry/2024/11/02/181430)を利用した場合でパフォーマンス差があることに気づきました。検証を進めていたところメソッドを使用することでパフォーマンスに影響がするのではないか？と考えました。
そこで、さまざまな形のメソッドを作成し、1,000,000回のメソッド呼び出しにかかる時間を比較しました。

---

## メソッドの種類でパフォーマンスが変わるのか？

### 検証するメソッド
```charp
private int Method()
{
  return 12345;
}
```

### テスト項目
- **DirectExecution**: メソッドを使用せず、直接処理を記述。
- **Method**: 検証するメソッド。
- **StaticMethod**: 静的プライベートメソッドを使用。
- **OutMethod**: `out` パラメータを用いてvoidメソッドに変更。
- **LambdaMethod**: 戻り値にラムダ式を用いた処理。

### ベンチマーク結果

| テスト項目                          | Median (ms) | Min (ms) | Max (ms) |  |
|-------------------------------------|-------------|----------|----------|-----------------|
| **DirectExecution**                 | 216.876     | 214.639  | 222.647  | 1.00            |
| **Method**                      | 264.2985    | 259.334  | 272.368  | 1.22            |
| **StaticMethod**                | 262.20835   | 260.087  | 267.213  | 1.21            |
| **OutMethod**                      | 273.23445   | 270.378  | 279.690  | 1.26            |
| **LambdaMethod**                   | 262.62515   | 259.630  | 267.605  | 1.21            |

---

## 引数の数でパフォーマンスが変わるのか？

### テスト項目
- **Arg1Method**: 引数1個のメソッド呼び出し。
- **Arg10Method**: 引数10個のメソッド呼び出し。
- **Arg20Method**: 引数20個のメソッド呼び出し。

### ベンチマーク結果

| テスト項目                            | Median (ms) | Min (ms) | Max (ms) |  |
|-------------------------------------|-------------|----------|----------|-----------------|
| **DirectExecution**                 | 216.876     | 214.639  | 222.647  | 1.00            |
| **Method**                      | 264.2985    | 259.334  | 272.368  | 1.22            |
| **Arg1Method**                     | 273.18325   | 269.786  | 278.649  | 1.26            |
| **Arg10Method**                    | 1168.52965  | 1161.699 | 1177.168 | 5.39            |
| **Arg20Method**                    | 2167.68555  | 2154.362 | 2188.336 | 10.00           |

---

## 引数の型でパフォーマンスが変わるのか？

### テスト項目
- **ArgTypeBool**: `bool`型の引数を持つメソッド。
- **ArgTypeInt**: `int`型の引数を持つメソッド。
- **ArgTypeLong**: `long`型の引数を持つメソッド。
- **ArgTypeDataToken**: `DataToken`型の引数を持つメソッド。
- **ArgTypeUdonBehaviour**: `UdonBehaviour`型の引数を持つメソッド。ベンチマークを行っているスクリプトを与えました(`this`)。

### ベンチマーク結果

| テスト項目                            | Median (ms) | Min (ms) | Max (ms) |  |
|-------------------------------------|-------------|----------|----------|-----------------|
| **DirectExecution**                 | 216.876     | 214.639  | 222.647  | 1.00            |
| **ArgTypeBool**              | 275.93615   | 272.869  | 278.417  | 1.27            |
| **ArgTypeInt**               | 272.9503    | 270.165  | 281.030  | 1.26            |
| **ArgTypeLong**              | 275.89725   | 272.917  | 279.612  | 1.27            |
| **ArgTypeDataToken**         | 364.15465   | 359.776  | 383.137  | 1.68            |
| **ArgTypeUdonBehaviour**     | 597.0399    | 592.076  | 607.551  | 2.75            |

---

## まとめ
1. **メソッドの使用による影響**  
   DirectExecution（直接実行）と比較すると、メソッド呼び出しには一定のパフォーマンス低下が見られました。ただし、メソッドの形状（静的メソッドやラムダ式など）による差はほとんどありませんでした。

2. **引数の数による影響**  
   引数の数が増えるほどパフォーマンスが低下することが確認されました。特に、10個以上の引数を持つメソッドでは大幅なコスト増加が発生します。

3. **引数の型による影響**  
   `int` や `long` などの基本型ではパフォーマンスに大きな差はありませんでした。しかし、`DataToken` や `UdonBehaviour` を引数に使用した場合、顕著なパフォーマンス低下が発生しました。特に、`UdonBehaviour` 型を引数に渡す場合は、処理速度に大きな影響を与えることがわかりました。他の型でも同様なことが発生するのか要検証。
