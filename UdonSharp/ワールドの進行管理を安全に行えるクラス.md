# 安全な進行管理をに行うクラスを作成しました(UdonSharp向け)

## はじめに

VRChat の UdonSharp で複数人プレイ用のワールドを作っていると、  進行管理や状態同期の問題に悩むことが多くあります。

>とくに
>
> - **複数人同時操作で状態が崩れる**  
> - **後から入った人（LateJoiner）が進行状況を引き継げない**
>   
> といった問題は、進行処理を組むうえで大きな壁になります。

今回はこれらを解決する **安全な進行管理クラス** を作成したので紹介します。

---

## 進行管理における同期通信について

進行管理や状態同期を設計する際、**UdonSync** と **SendCustomNetworkEvent** の
特性を正しく理解することはとても重要です。
それぞれの仕組みにはメリット・デメリットがあり、
使い分けを誤ると同期ミスや進行不具合が発生することがあります。

以下に、それぞれの特性を整理します。
### UdonSync の特性
- ✅オブジェクトの状態を全プレイヤー間で同期できる
- ✅LateJoiner も現在の状態を取得できる
- ❌値更新に`SetOwner`する必要があり、複数人で操作を行うと、値の増減が正しく同期されず、巻き戻りや他人の操作が消えるといった現象が発生します

### SendCustomNetworkEvent の特性
- ✅任意のイベント（メソッド呼び出し）をプレイヤーに送信できる
- ✅複数人で操作を行った場合でも動作が安定している
- ❌LateJoinerは過去に実行したイベントを取得できない

今回の実装では、
UdonSyncによる**値同期・LateJoiner対応**を行いつつ、
SendCustomNetworkEvent を使って**複数人操作を安定**させるようにしています。

---

## 安全性の向上

作成したクラスでは、
`OnPostSerialization` と `OnDeserialization` で
同期状態が送受信完了したタイミングで進行処理を行うようにしています。
これにより、SendCustomNetworkEvent が正常に動作しなかった場合でも
再送できる仕組みを入れています。

なお、[公式ドキュメント](https://creators.vrchat.com/worlds/udon/networking/#3-custom-network-events)
では SendCustomNetworkEvent は「確実に処理される」と記載されていますので、
この冗長処理は保険的なものですが、念のため実装しています。

## ソースコード

## 使用例 （ドアを専用鍵を使って開錠する）

## まとめ
